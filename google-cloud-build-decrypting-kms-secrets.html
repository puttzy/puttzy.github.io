<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Google Cloud Build decrypting KMS Secrets - Puttz&#x27;n Around the cloud</title><meta name="description" content="In trying to follow more best practices and create a true reference architecture for Java in GCP I was trying to store my service account credential files encrypted using KMS then pull them out and decrypt them using using GCP KMS Service.  In doing so though I kept getting an error through Cloud Build saying I didn't have decrypt permissions.  It pains me to admit that this took me much longer to solve than it should have, mostly because of a deeply rooted I.D.ten.T. error.  "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://puttzy.github.io/google-cloud-build-decrypting-kms-secrets.html"><link rel="alternate" type="application/atom+xml" href="https://puttzy.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://puttzy.github.io/feed.json"><meta property="og:title" content="Google Cloud Build decrypting KMS Secrets"><meta property="og:image" content="https://puttzy.github.io/media/posts/9/design-desk-eyewear-313690.jpg"><meta property="og:site_name" content="Puttz'n Around the cloud"><meta property="og:description" content="In trying to follow more best practices and create a true reference architecture for Java in GCP I was trying to store my service account credential files encrypted using KMS then pull them out and decrypt them using using GCP KMS Service.  In doing so though I kept getting an error through Cloud Build saying I didn't have decrypt permissions.  It pains me to admit that this took me much longer to solve than it should have, mostly because of a deeply rooted I.D.ten.T. error.  "><meta property="og:url" content="https://puttzy.github.io/google-cloud-build-decrypting-kms-secrets.html"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@puttznaround"><meta name="twitter:title" content="Google Cloud Build decrypting KMS Secrets"><meta name="twitter:description" content="In trying to follow more best practices and create a true reference architecture for Java in GCP I was trying to store my service account credential files encrypted using KMS then pull them out and decrypt them using using GCP KMS Service.  In doing so though I kept getting an error through Cloud Build saying I didn't have decrypt permissions.  It pains me to admit that this took me much longer to solve than it should have, mostly because of a deeply rooted I.D.ten.T. error.  "><meta name="twitter:image" content="https://puttzy.github.io/media/posts/9/design-desk-eyewear-313690.jpg"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><style>h1,h2,h3,h4,h5,h6,.btn,[type=button],[type=submit],button,.navbar .navbar__menu li,.navbar_mobile_sidebar .navbar__menu li,.feed__author,.post__tag,.post__share>a span,.post__nav-link>span,.footer{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}body,h1,.h1,blockquote,.search__input,.author__name,.author__info>p,.feed__item h2,.post__nav-link{font-family:'PT Serif',Georgia,"Times New Roman",Times,serif}</style><link rel="stylesheet" href="https://puttzy.github.io/assets/css/style.css?v=69181b9c1a3c8ca8f05c97047b5650ac"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://puttzy.github.io/google-cloud-build-decrypting-kms-secrets.html"},"headline":"Google Cloud Build decrypting KMS Secrets","datePublished":"2019-09-10T09:50","dateModified":"2019-09-10T10:42","image":{"@type":"ImageObject","url":"https://puttzy.github.io/media/posts/9/design-desk-eyewear-313690.jpg","height":3456,"width":4608},"description":"<p>In trying to follow more best practices and create a true reference architecture for Java in GCP I was trying to store my service account credential files encrypted using KMS then pull them out and decrypt them using using GCP KMS Service.  In doing so though I kept getting an error through Cloud Build saying I didn't have decrypt permissions.  </p>\n<p>It pains me to admit that this took me much longer to solve than it should have, mostly because of a deeply rooted <a href=\"https://www.urbandictionary.com/define.php?term=ID10T\">I.D.ten.T. error.</a>  </p>\n","author":{"@type":"Person","name":"Dan Putt"},"publisher":{"@type":"Organization","name":"Dan Putt","logo":{"@type":"ImageObject","url":"https://puttzy.github.io/media/website/Bokehlicia-Captiva-Cloud.ico","height":false,"width":false}}}</script><script src="https://puttzy.github.io/assets/js/ls.parent-fit.min.js?v=1c78585e2a70398fe95085061942fd37"></script><script async src="https://puttzy.github.io/assets/js/lazysizes.min.js?v=149ff45fc6c2f13e892e438a58abb77f"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-147214067-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147214067-1');</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://puttzy.github.io/"><img src="https://puttzy.github.io/media/website/Bokehlicia-Captiva-Cloud.ico" alt="Puttz&#x27;n Around the cloud"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li class="has-submenu"><a href="https://puttzy.github.io/gcp/" target="_self" aria-haspopup="true">GCP</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://puttzy.github.io/cloud-run/" target="_self">Cloud Run</a></li><li><a href="https://puttzy.github.io/cloud-build/" target="_self">Cloud Build</a></li><li><a href="https://puttzy.github.io/kms/" target="_self">KMS</a></li></ul></li><li class="has-submenu"><a href="https://puttzy.github.io/java/" target="_self" aria-haspopup="true">Java</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://puttzy.github.io/springboot/" target="_self">Spring Boot</a></li></ul></li><li><a href="https://github.com/puttzy/" target="_self">My Github</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><form action="https://puttzy.github.io/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="search..." autofocus="autofocus"></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false"><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post"><div class="hero"><figure class="hero__image"><img class="hero__image-img lazyload" data-src="https://puttzy.github.io/media/posts/9/design-desk-eyewear-313690.jpg" data-srcset="https://puttzy.github.io/media/posts/9/responsive/design-desk-eyewear-313690-xs.jpg 300w ,https://puttzy.github.io/media/posts/9/responsive/design-desk-eyewear-313690-sm.jpg 480w ,https://puttzy.github.io/media/posts/9/responsive/design-desk-eyewear-313690-md.jpg 768w ,https://puttzy.github.io/media/posts/9/responsive/design-desk-eyewear-313690-lg.jpg 1024w ,https://puttzy.github.io/media/posts/9/responsive/design-desk-eyewear-313690-xl.jpg 1360w ,https://puttzy.github.io/media/posts/9/responsive/design-desk-eyewear-313690-2xl.jpg 1600w" data-aspectratio="1.3333333333333333" data-sizes="auto" alt="" height="3456" width="4608"></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2019-09-10T09:50">September 10, 2019</time></div><h1>Google Cloud Build decrypting KMS Secrets</h1><div class="post__meta post__meta--author"><a href="https://puttzy.github.io/authors/dan-putt/" class="feed__author invert">Dan Putt</a></div></div></header></div><div class="wrapper post__entry"><p>In trying to follow more best practices and create a true reference architecture for Java in GCP I was trying to store my service account credential files encrypted using KMS then pull them out and decrypt them using using GCP KMS Service.  In doing so though I kept getting an error through Cloud Build saying I didn't have decrypt permissions.  </p><p>It pains me to admit that this took me much longer to solve than it should have, mostly because of a deeply rooted <a href="https://www.urbandictionary.com/define.php?term=ID10T">I.D.ten.T. error.</a>  </p><p>I started this process by following most of the excellent guide I found on a post on Medium - <a href="https://medium.com/google-cloud/using-google-cloud-platforms-cloud-key-management-service-kms-to-encrypt-decrypt-secrets-8ca7454a6b96">Using GCP's Cloud Key Management Serice (KMS) to Encrypt/Decrypt Secrets</a>.</p><p>In an earlier post I mentioned that I was storing my credentials file in a cloud storage bucket unencrypted.  Not great, right?  Changing that to storing an excrypted file was actually quite easy using GCP's KMS system.  </p><p>The first thing one should do is create a new key-ring and new key - <em>keep in mind that key-rings cannot be deleted</em></p><pre>gcloud kms keys create datastore-key \<br>--location global \<br>--keyring {your_keyring_name} \<br>--purpose encryption</pre><p>Then we'll create a new key and encrypt our plaintext (credetial) file into a new ciphertext (encrypted credential) file to upload into our cloud storage bucket.  If you saw <a href="inject-credentials-file-during-cloud-build.html">my previous post</a>, you may know that the file I'm working with is a service account credentials file I created to allow StackDriver logging to be done through my cloud run application.  This file is being pulled down via one of my build steps.  But now, before uploading it, I want to encrypt it.   </p><pre>gcloud kms encrypt --location=global \<br>  --keyring=development-key-ring \<br>  --key=datastore-key \<br>  --plaintext-file=logging_service_account.json \<br>  --ciphertext-file=encrypted_logging_service_account.json</pre><p>The command above uses the key-ring we previosuly created, uses a new key of "data-store" and encrypts the local <em>logging_service_account.json</em> to a new file called <em>encyrpted_local logging_service_account.json</em>.  This encrypted file is what I'll now put in my storage bucket to be pulled, decrypted, and injected into my cloud run container via cloud build.</p><pre>  # Pull the credentials file from our storage bucket<br>- name: 'gcr.io/cloud-builders/gsutil'<br>  args: ['cp', 'gs://{bucket_name}/encrypted_logging_service_account.json', './src/main/jib/cred']<br><br>  # decrypt the credentials file that we just pulled down<br>- name: 'gcr.io/cloud-builders/gcloud'<br>  args: ['kms', 'decrypt', '--location', 'global', '--keyring', 'development-key-ring', '--key', 'datastore-key', '--ciphertext-file', './src/main/jib/cred/encrypted_logging_service_account.json', '--plaintext-file', './src/main/jib/cred/logging_service_account.json']</pre><p> </p><p>Notice that the decrypt step, the second one, is virtually a reversal of the previous encrypt step.  </p><p>Now we should be good to go.  Run our cloud build and all is right with the world.... Until we get a permissions issue.</p><p class="msg msg--warning">ERROR: build step 1 "gcr.io/cloud-builders/gcloud" failed: exit status 1<br>ERROR<br>Finished Step #1<br>Step #1: ERROR: (gcloud.kms.decrypt) PERMISSION_DENIED: Permission 'cloudkms.cryptoKeyVersions.useToDecrypt' denied for resource 'projects/inventory-dev-project/locations/global/keyRings/development-key-ring/cryptoKeys/datastore-key'.</p><p> </p><figure class="post__image--left"><img class="lazyload" data-src="https://puttzy.github.io/media/posts/9/Screen-Shot-2019-09-09-at-11.10.08-PM.png" data-sizes="auto" data-srcset="https://puttzy.github.io/media/posts/9/responsive/Screen-Shot-2019-09-09-at-11.10.08-PM-xs.png 300w ,https://puttzy.github.io/media/posts/9/responsive/Screen-Shot-2019-09-09-at-11.10.08-PM-sm.png 480w ,https://puttzy.github.io/media/posts/9/responsive/Screen-Shot-2019-09-09-at-11.10.08-PM-md.png 768w ,https://puttzy.github.io/media/posts/9/responsive/Screen-Shot-2019-09-09-at-11.10.08-PM-lg.png 1024w ,https://puttzy.github.io/media/posts/9/responsive/Screen-Shot-2019-09-09-at-11.10.08-PM-xl.png 1360w ,https://puttzy.github.io/media/posts/9/responsive/Screen-Shot-2019-09-09-at-11.10.08-PM-2xl.png 1600w" alt="Add the KMS Decrypt Role to Cloud Run Agent" data-aspectratio="1.270492" width="310" height="244"></figure>This is where I spent more time than I'll readily admit.  Just know that I had the best of intentions when I started adding the "Cloud KMS CryptoKey Decrypter" to my Cloud Build service account.  The wrong service account apparently.  But we won't get into that.  Suffice it to say that once I added the permission to the correct account everything worked fine.<p></p><p> </p><p>In my trial and error though I did learn that I can also do this via <a href="https://cloud.google.com/kms/docs/iam">GCloud commands</a>:</p><pre>gcloud kms keyrings add-iam-policy-binding  \<br>  --location=global development-key-ring \<br>  --member=serviceAccount:{unique_id}@cloudbuild.gserviceaccount.com \<br>  --role=roles/cloudkms.cryptoKeyDecrypter</pre><p>So there you have it.  Encrypting a file, putting it in cloud storage, pulling it during cloud build, decrypting it, and injecting it into our container to be used at runtime.  </p><h3><strong>Some other things I learned and next steps:</strong></h3><h4>1. Determine what service account is the GCP  running process under</h4><p>When debugging and trying to figure out why my service account constantly got permission denied even though I kept adding the permissions I realized I was working with the wrong service account.  I was able to figure this out with a simple step in my cloud build that told me who the agent was running as:</p><pre>- name: 'gcr.io/cloud-builders/gcloud'<br>  args: ['auth', 'list']</pre><p>which outputted:</p><pre class="p6n-gcb-log p6n-gcb-log-wrap-lines">* <strong>{unique_project_id}@cloudbuild.gserviceaccount.com</strong>
ACTIVE ACCOUNT
Credentialed Accounts</pre><h4>2. Next Step Encrypt the Storage Bucket and not the file itself</h4><p>I believe it would be beneficial to <a href="https://cloud.google.com/storage/docs/encryption/">encrypt the bucket</a> and everything that goes into it so that everything is automatically encrypted.  This ensure much better security.</p><p> </p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on September 10, 2019</p><ul class="post__tag"><li><a href="https://puttzy.github.io/cloud-build/">cloud build</a></li><li><a href="https://puttzy.github.io/gcp/">gcp</a></li><li><a href="https://puttzy.github.io/kms/">kms</a></li></ul><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fputtzy.github.io%2Fgoogle-cloud-build-decrypting-kms-secrets.html" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fputtzy.github.io%2Fgoogle-cloud-build-decrypting-kms-secrets.html&amp;via=puttznaround&amp;text=Google%20Cloud%20Build%20decrypting%20KMS%20Secrets" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fputtzy.github.io%2Fgoogle-cloud-build-decrypting-kms-secrets.html&amp;title=Google%20Cloud%20Build%20decrypting%20KMS%20Secrets" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span></a></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://puttzy.github.io/inject-credentials-file-during-cloud-build.html" class="invert post__nav-link" rel="prev"><span>Previous</span> Inject Credentials file with Cloud Build</a></div><div class="post__nav-next"><a href="https://puttzy.github.io/managing-google-runtime-configurations.html" class="invert post__nav-link" rel="next"><span>Next</span> Managing Google Runtime Configurations </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__related related"><div class="wrapper"><h2 class="h5 related__title">You should also read:</h2><article class="related__item"><div class="feed__meta"><time datetime="2019-09-26T09:56" class="feed__date">September 26, 2019</time></div><h3 class="h1"><a href="https://puttzy.github.io/managing-google-runtime-configurations.html" class="invert">Managing Google Runtime Configurations</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2019-09-09T22:20" class="feed__date">September 9, 2019</time></div><h3 class="h1"><a href="https://puttzy.github.io/inject-credentials-file-during-cloud-build.html" class="invert">Inject Credentials file with Cloud Build</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2019-09-06T21:56" class="feed__date">September 6, 2019</time></div><h3 class="h1"><a href="https://puttzy.github.io/deploying-springboot-container-to-cloud-run-via-cloud-build.html" class="invert">Cloud Build + Cloud Run Errors</a></h3></article></div></div><div class="post__comments"><div class="wrapper"><h2 class="h5">Comments</h2><div id="disqus_thread"></div><script>var disqus_config = function () {
                       this.page.url = 'https://puttzy.github.io/google-cloud-build-decrypting-kms-secrets.html';
               		this.page.identifier = '9';
                       this.page.title = ' Google Cloud Build decrypting KMS Secrets';
                   };
               
                   var disqus_loaded = false;
               
                   function publiiLoadDisqus() {
                       if(disqus_loaded) {
                           return false;
                       }
               
                       var top = document.getElementById('disqus_thread').offsetTop;
               
                       if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                           disqus_loaded = true;
               
                           (function () {
                               var d = document, s = d.createElement('script');
                               s.src = 'https://puttzy.disqus.com/embed.js';
                               s.setAttribute('data-timestamp', +new Date());
                               (d.head || d.body).appendChild(s);
                           })();
                       }
                   }
               
                   publiiLoadDisqus();
               
                   window.onscroll = function() {
                       publiiLoadDisqus();
                   };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></main><footer class="footer"><div class="footer__social"><a href="https://twitter.com/puttznaround" aria-label="Twitter"><svg><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#twitter"/></svg> </a><a href="https://instagram.com/puttzy" aria-label="Instagram"><svg><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#instagram"/></svg> </a><a href="https://www.linkedin.com/in/danielputt/" aria-label="LinkedIn"><svg><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#linkedin"/></svg></a></div><div class="footer__copyright"><p>Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener noreferrer">Publii Static CMS</a></p></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://puttzy.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'overlay',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://puttzy.github.io/assets/js/scripts.min.js?v=f56b13ba141d95ea2a0b7aab75ca9528"></script><script>var lazyFeaturedImage=function lazyFeaturedImage(){var b=document.querySelectorAll(".hero__image-img");for(var a=0;a<b.length;a++){var c=b[a];c.addEventListener("lazyloaded",function(f){var d=f.target.parentNode;d.classList.add("hero__image--overlay")})}};lazyFeaturedImage();</script><script>document.getElementsByClassName('footer__social')[0].innerHTML += ('<a href="https://github.com/puttzy/" aria-label="GitHub"> <svg viewbox="0 0 24 24"> <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"> </svg></a>')</script></body></html>